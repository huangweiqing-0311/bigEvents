<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>文章列表</title>
  <link rel="stylesheet" href="js/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/reset.css" />
  <link rel="stylesheet" href="css/iconfont.css" />
  <link rel="stylesheet" href="css/main.css" />
  <script src="js/jquery-1.12.4.min.js"></script>
  <script src="js/bootstrap/js/bootstrap.min.js"></script>

</head>

<body>
  <div class="container-fluid">
    <div class="common_title">
      文章类别管理
    </div>
    <div class="container-fluid common_con">
      <table class="table table-striped table-bordered table-hover mp20 category_table">
        <thead>
          <tr>
            <th>名称</th>
            <th>Slug</th>
            <th class="text-center" width="100">操作</th>
          </tr>
        </thead>
        <tbody>
           <tr>
            <td>未分类</td>
            <td>uncategorized</td>
            <td class="text-center">
              <a href='javascript:editTr({"id":"1","slug":"uncategorized","name":"未分类"});'
                class="btn btn-info btn-xs">编辑</a>
              <a href="javascript:deleteTr( 1 );" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>

          <tr>
            <td>奇趣事</td>
            <td>funny</td>
            <td class="text-center">
              <a href='javascript:editTr({"id":"2","slug":"funny","name":"奇趣事"});' class="btn btn-info btn-xs">编辑</a>
              <a href="javascript:deleteTr( 2 );" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>

          <tr>
            <td>会生活</td>
            <td>living</td>
            <td class="text-center">
              <a href='javascript:editTr({"id":"3","slug":"living","name":"会生活"});' class="btn btn-info btn-xs">编辑</a>
              <a href="javascript:deleteTr( 3 );" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>

          <tr>
            <td>爱旅行</td>
            <td>travel</td>
            <td class="text-center">
              <a href='javascript:editTr({"id":"4","slug":"travel","name":"爱旅行"});' class="btn btn-info btn-xs">编辑</a>
              <a href="javascript:deleteTr( 4 );" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>  
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="text-center">
              <a href="#" class="btn btn-add btn-success btnAddCate" data-toggle="modal" data-target="#addModal">新增分类</a>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- 模态框 -->
  <div class="modal fade" id="addModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
          <h4 class="modal-title">新增分类</h4>
        </div>
        <div class="modal-body">
          <form>
            <!-- 隐藏域 -->
            <input type="hidden" name="id" class="id">
            <div class="form-group">
              <label for="recipient-name" class="control-label">分类名称:</label>
              <input type="text" name="name" class="form-control name" id="recipient-name">
            </div>
            <div class="form-group">
              <label for="message-text" class="control-label">分类别名:</label>
              <input type="text" name="slug" class="form-control slug" id="recipient-slug">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="model_shutoff">关闭</button>
          <button type="button" class="btn btn-primary" id="model_add">新增</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $('#addModal').modal({
      show: false,
      backdrop: false
    })

    $('#model_shutoff').click(function () {
      alert('shutoff')
      $('#addModal').modal('hide')
    })

    $('.category_table').delegate('a', 'click', function () {
      if ($(this).hasClass('btn-info')) {
        $('#addModal .modal-title').html('修改分类名称')
        $('#addModal').modal('show')
        
      }
    })
  </script>
  <!-- 导入模板引擎 -->
  <script src="./js/template-web.js"></script>
  <!-- 定义模板 -->
  <script id="tmp" type="text/html">
        {{each data }}
        <tr>
            <td>{{$value.name}}</td>
            <td>{{$value.slug}}</td>
            <td class="text-center">
                <a href="#" data-id="{{$value.id}}" class="btn btn-info btn-xs btn-edit">编辑</a>
                <a href="#" data-id="{{$value.id}}" class="btn btn-danger btn-xs btn-delete">删除</a>
            </td>
          </tr>
        {{/each}}
     </script>
     <!-- 模板2 -->
     <!-- <script type="text/html" id="tmp2">
      <tr>
        <td>{{ name}}</td>
        <td>{{ slug}}</td>
        <td class="text-center">
            <a href="javascript:editTr({&quot;id&quot;:&quot;1&quot;,&quot;slug&quot;:&quot;uncategorized&quot;,&quot;name&quot;:&quot;未分类&quot;});"
                class="btn btn-info btn-xs">编辑</a>
            <a href="#" data-id="{{id}}" class="btn btn-danger btn-xs btn-delete">删除</a>
        </td>
      </tr>
    </script> -->
 <!-- javascript:deleteTr( {{$value.id}} ); -->
  <!-- 自己的逻辑 -->
  <script>
     /*
       1.获取文章分类数据显示到页面上-发送ajax请求

       2.给模态框的新增按钮添加点击事件
        2.0隐藏模态框
        2.1获取用户输入的数据,发送ajax请求,成功后重新渲染页面,为了取得最新数据,
      
       3.给删除的按钮设置委托事件
        3.1在模板里给每一个按钮设置一个自定义属性data-id,方便获取到他
        3.2通过tbody给删除按钮设置点击事件,并且阻止事件默认行为
        3.3保存当前点击的this,并且获取id
        3.3发送ajax请求,通过that找打它要删除的元素

      4.点击编辑的事件
        4.0隐藏模态框
        4.1给编辑按钮设置一个btn-success属性[因为它和新增用的都是同一个弹出框,做判断用]  
        4.2获取要修改的内容, id,name,slug,把它们赋值给弹出框对应的标签中,
        4.3发送ajax请求,用serialize的方法获取表单元素的name属性--拼接成字符串
        4.4修改成功,重新渲染页面
        4.5用事件委托的方法给编辑按钮添加点击事件,并且添加一个btn-success类,并且修改model_add文本按钮内容
        

      5.点击新增按钮时,要移出弹出框的btn-success类,并且清空弹出框的内容

        
         
           
     */

    //1.获取文章分类数据显示到页面上--封装成函数
    function getData() {
      $.ajax({
        url: 'http://localhost:8000/admin/category_search',
        success: function (res) {
          //  console.log(res);
          if (res.code == 200) {
            var html = template('tmp', res);
            $('tbody').html(html);
          }
        }
      });
    }
    //一进来就发送ajax请求,显示所有的文章类别
    getData();

    //2.[需求]
    //2.-给弹出来的模态框里面,新增按钮/编辑按钮-设置点击事件
    $('#model_add').click(function () {

      //2.1点击编辑-判断这个按钮是否拥有btn-success属性[有-编辑]
      if($(this).hasClass('btn-success')) {
         
           //获取用户要修改的内容
          // var name = $('#recipient-name').val();  // 获取分类名称
          // var slug = $('#recipient-slug').val();  //获取分类别名
          // var id = $('.modal-body .id').val();
          //console.log(id);
          //使用serialize的方法(jQuery)获取表单元素的name属性
          var data = $(".modal-body form").serialize();  // 拼接成字符串
          //发送ajax请求
          $.post({
              url: 'http://localhost:8000/admin/category_edit',
              data: data,
              success: function(res){
                 console.log(res);
                 if(res.code == 200){
                    alert('修改成功!');
                    getData();
                 }
              }
          })

      } else{   
       
      //2.2-获取用户输入的信息
      var cateName = $('#recipient-name').val().trim();
      var cateSlug = $('#recipient-slug').val().trim();

      //2.3-发送ajax请求
       $.ajax({
        type: 'post',
        url: 'http://localhost:8000/admin/category_add',
        data: {
          name: cateName,
          slug: cateSlug,
            },
        success: function (res) {
            console.log(res);
          if (res.code == 200) {
            
              //重新获取数据
              getData(); 
           }
          }
      }); 
    }
    
      //隐藏模态框        
       $('#addModal').modal('hide');

      })

      
    //[需求]: 点击新增分类按钮, 模态框中的按钮还原
    $('.btnAddCate').on('click', function(){
      $('#addModal .modal-title').html('新增分类'); 
      $('#model_add').text('新增').removeClass('btn-success'); 

        $('form input').val('');
       
    })

      //[需求]: 事件委托的方法编辑用户信息
      $('tbody').on('click', '.btn-edit', function(){
        $('#addModal .modal-title').html('修改分类名称')
        $('#addModal').modal('show')
        $('#model_add').addClass('btn-success').text('修改') 
        
        //获取你要编辑的id,name,slug
        var id = $(this).attr('data-id')  // 获取 id
        var slug = $(this).parent().prev().text()  // 获取你要你要编辑的文章类别别名
        var name = $(this).parent().prev().prev().text()  // 获取你要编辑的文章的别名
        //把获取到的id,name,slug对应的属性名显示到编辑框中(模态框)
        $('.modal-body .id').val(id)
        $('#recipient-name').val(name)
        $('#recipient-slug').val(slug)
        
        $('#addModal').modal('show'); 
       })
    

    //[需求]: 事件委托的方法来删除
     $('tbody').on('click', '.btn-delete', function(e){
            e.preventDefault();
             
            if(confirm('你确认要删除吗?')){
                //获取当前要删除的这个项的id
                var cateId = $(this).attr('data-id');
                //保存当前点击的这个按钮
                var that = $(this);
                //发送ajax请求
                $.post({
                    url: 'http://localhost:8000/admin/category_delete',
                    data: {id: cateId},
                    success: function(res){
                       if(res.code == 200){
                         //删除成功,刷新页面
                          // getData();
                          that.parents('tr').remove();
                       }
                    }
                })
            }
     })

  </script>
</body>

</html>